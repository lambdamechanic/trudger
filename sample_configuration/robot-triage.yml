# Robot triage
# - Selects tasks via `bv --robot-triage`, then picks the first
#   blocker-to-clear that is not status=blocked (exits 1 when none).
# - No label changes (hooks are no-ops).
# - On interruption or failure, resets task status to open (task id via TRUDGER_TASK_ID).
default_profile: codex
profiles:
  codex:
    trudge: codex
    trudge_review: codex-review
  z.ai:
    trudge: z.ai
    trudge_review: z.ai
invocations:
  codex:
    command: 'codex --yolo exec --model gpt-5.2-codex --reasoning medium --prompt "$TRUDGER_PROMPT"'
  codex-review:
    command: 'codex --yolo exec --model gpt-5.2-codex --reasoning medium --prompt "$TRUDGER_REVIEW_PROMPT" "$@"'
  z.ai:
    command: 'pi_trudge --prompt-env TRUDGER_AGENT_PROMPT'
commands:
  next_task: 'task_id=""; while IFS= read -r candidate; do status=$(br show "$candidate" --json | jq -r "if type == \"array\" then .[0].status // \"\" else .status // \"\" end"); if [[ "$status" != "blocked" ]]; then task_id="$candidate"; break; fi; done < <(bv --robot-triage | jq -r ".triage.blockers_to_clear[] | select(.actionable == true) | .id"); if [[ -z "$task_id" ]]; then exit 1; fi; printf "%s" "$task_id"'
  task_show: 'br show "$TRUDGER_TASK_ID"'
  task_status: 'br show "$TRUDGER_TASK_ID" --json | jq -r "if type == \"array\" then .[0].status // \"\" else .status // \"\" end"'
  task_update_status: 'br update "$TRUDGER_TASK_ID" --status "$TRUDGER_TARGET_STATUS"'
review_loop_limit: 5
log_path: "./.trudger.log"

hooks:
  on_completed: "true"
  on_requires_human: "true"
  on_doctor_setup: 'rm -rf "$TRUDGER_DOCTOR_SCRATCH_DIR/.beads"; cp -R ".beads" "$TRUDGER_DOCTOR_SCRATCH_DIR/"'
