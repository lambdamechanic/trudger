# Trudgeable with hooks
# - Selects the next ready br task labeled "trudgeable" (exits 1 when none).
# - On completion, removes the "trudgeable" label (task id via TRUDGER_TASK_ID).
# - On requires-human, removes "trudgeable" and adds "human_required" (task id via TRUDGER_TASK_ID).
# - On interruption or failure, resets task status to open (task id via TRUDGER_TASK_ID).
default_profile: codex
profiles:
  codex:
    trudge: codex
    trudge_review: codex-review
invocations:
  codex:
    command: 'codex --yolo exec --model gpt-5.2-codex --reasoning medium --prompt "$TRUDGER_PROMPT"'
  codex-review:
    command: 'codex --yolo exec --model gpt-5.2-codex --reasoning medium --prompt "$TRUDGER_REVIEW_PROMPT" "$@"'
commands:
  next_task: 'task_id=$(br ready --json --label trudgeable --sort priority --limit 1 | jq -r "if type == \"array\" and length > 0 then .[0].id // \"\" else \"\" end"); if [[ -z "$task_id" ]]; then exit 1; fi; printf "%s" "$task_id"'
  task_show: 'br show "$TRUDGER_TASK_ID"'
  task_status: 'br show "$TRUDGER_TASK_ID" --json | jq -r "if type == \"array\" then .[0].status // \"\" else .status // \"\" end"'
  task_update_status: 'br update "$TRUDGER_TASK_ID" --status "$TRUDGER_TARGET_STATUS"'
review_loop_limit: 5
log_path: "./.trudger.log"

hooks:
  on_completed: 'br label remove "$TRUDGER_TASK_ID" "trudgeable"'
  on_requires_human: 'br label remove "$TRUDGER_TASK_ID" "trudgeable"; br label add "$TRUDGER_TASK_ID" "human_required"'
  on_doctor_setup: 'rm -rf "$TRUDGER_DOCTOR_SCRATCH_DIR/.beads"; cp -R ".beads" "$TRUDGER_DOCTOR_SCRATCH_DIR/"'
  # Optional notification hook (receives TRUDGER_NOTIFY_* env vars, no positional args).
  # - `TRUDGER_NOTIFY_PAYLOAD_PATH` points to a JSON payload file containing the same fields.
  # on_notification: 'printf "event=%s task=%s msg=%s\n" "$TRUDGER_NOTIFY_EVENT" "$TRUDGER_NOTIFY_TASK_ID" "$TRUDGER_NOTIFY_MESSAGE"'
  # Scope options:
  # - task_boundaries (default when on_notification is set): task_start/task_end
  # - run_boundaries: run_start/run_end
  # - all_logs: one hook call per transition log message (includes TRUDGER_NOTIFY_MESSAGE)
  # on_notification_scope: "task_boundaries"
