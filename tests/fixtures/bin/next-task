#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=tests/fixtures/bin/_queue_helpers
source "${SCRIPT_DIR}/_queue_helpers"

exit_code="${NEXT_TASK_EXIT_CODE:-0}"

if [[ -n "${NEXT_TASK_OUTPUT_QUEUE:-}" && -f "${NEXT_TASK_OUTPUT_QUEUE}" ]]; then
  if line="$(fixture_queue_pop "${NEXT_TASK_OUTPUT_QUEUE}")"; then
    printf '%s' "${line}"
  fi
  exit "$exit_code"
fi

if [[ -n "${NEXT_TASK_OUTPUT_FILE:-}" && -f "${NEXT_TASK_OUTPUT_FILE}" ]]; then
  cat "${NEXT_TASK_OUTPUT_FILE}"
  exit "$exit_code"
fi

printf '%s' "${NEXT_TASK_OUTPUT:-}"
exit "$exit_code"
