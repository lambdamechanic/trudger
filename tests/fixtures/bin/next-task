#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=tests/fixtures/bin/_queue_helpers
source "${SCRIPT_DIR}/_queue_helpers"

exit_code="${NEXT_TASK_EXIT_CODE:-0}"
log_path="${NEXT_TASK_LOG:-}"

if [[ -n "${log_path}" ]]; then
  sanitize_log_value() {
    local value="$1"
    value="${value//$'\n'/\\n}"
    value="${value//$'\r'/\\r}"
    value="${value//$'\t'/\\t}"
    printf '%s' "$value"
  }
  log_env_flag() {
    local name="$1"
    if [[ -v $name ]]; then
      printf 'envset %s=1\n' "$name"
    else
      printf 'envset %s=0\n' "$name"
    fi
  }
  log_env_value() {
    local name="$1"
    local value="${!name-}"
    printf 'env %s=%s\n' "$name" "$(sanitize_log_value "$value")"
  }
  {
    printf 'next-task args_count=%s args=%s\n' "$#" "$*"
    printf 'cwd %s\n' "$(pwd -P)"
    log_env_flag "TRUDGER_AGENT_PROMPT"
    log_env_flag "TRUDGER_AGENT_PHASE"
    log_env_flag "TRUDGER_TASK_ID"
    log_env_flag "TRUDGER_TASK_SHOW"
    log_env_flag "TRUDGER_TASK_STATUS"
    log_env_flag "TRUDGER_CONFIG_PATH"
    log_env_flag "TRUDGER_DOCTOR_SCRATCH_DIR"
    log_env_value "TRUDGER_TASK_ID"
    log_env_value "TRUDGER_TASK_SHOW"
    log_env_value "TRUDGER_TASK_STATUS"
    log_env_value "TRUDGER_CONFIG_PATH"
    log_env_value "TRUDGER_DOCTOR_SCRATCH_DIR"
  } >> "${log_path}"
fi

if [[ -n "${NEXT_TASK_OUTPUT_QUEUE:-}" && -f "${NEXT_TASK_OUTPUT_QUEUE}" ]]; then
  if line="$(fixture_queue_pop "${NEXT_TASK_OUTPUT_QUEUE}")"; then
    printf '%s' "${line}"
  fi
  exit "$exit_code"
fi

if [[ -n "${NEXT_TASK_OUTPUT_FILE:-}" && -f "${NEXT_TASK_OUTPUT_FILE}" ]]; then
  cat "${NEXT_TASK_OUTPUT_FILE}"
  exit "$exit_code"
fi

printf '%s' "${NEXT_TASK_OUTPUT:-}"
exit "$exit_code"
