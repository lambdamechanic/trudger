#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=tests/fixtures/bin/_queue_helpers
source "${SCRIPT_DIR}/_queue_helpers"

log_path="${BV_MOCK_LOG:-}"
if [[ -n "${log_path}" ]]; then
  printf 'bv %s\n' "$*" >> "${log_path}"
fi

cmd="${1:-}"
shift || true

case "${cmd}" in
  --robot-next)
    if [[ -n "${BV_MOCK_ROBOT_NEXT_QUEUE:-}" && -f "${BV_MOCK_ROBOT_NEXT_QUEUE}" ]]; then
      if line="$(fixture_queue_pop "${BV_MOCK_ROBOT_NEXT_QUEUE}")"; then
        if [[ -n "${line}" ]]; then
          printf '%s\n' "${line}"
        fi
      fi
    else
      printf '%s\n' "${BV_MOCK_ROBOT_NEXT_JSON:-}"
    fi
    ;;
  *)
    printf 'bv stub: unsupported command %s\n' "${cmd}" >&2
    exit 1
    ;;
esac
