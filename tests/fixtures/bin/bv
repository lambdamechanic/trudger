#!/usr/bin/env bash
set -euo pipefail

log_path="${BV_MOCK_LOG:-}"
if [[ -n "${log_path}" ]]; then
  printf 'bv %s\n' "$*" >> "${log_path}"
fi

cmd="${1:-}"
shift || true

case "${cmd}" in
  --robot-next)
    if [[ -n "${BV_MOCK_ROBOT_NEXT_QUEUE:-}" && -f "${BV_MOCK_ROBOT_NEXT_QUEUE}" ]]; then
      if read -r line < "${BV_MOCK_ROBOT_NEXT_QUEUE}"; then
        tail -n +2 "${BV_MOCK_ROBOT_NEXT_QUEUE}" > "${BV_MOCK_ROBOT_NEXT_QUEUE}.tmp" || true
        mv "${BV_MOCK_ROBOT_NEXT_QUEUE}.tmp" "${BV_MOCK_ROBOT_NEXT_QUEUE}"
        if [[ -n "${line}" ]]; then
          printf '%s\n' "${line}"
        fi
      fi
    else
      printf '%s\n' "${BV_MOCK_ROBOT_NEXT_JSON:-}"
    fi
    ;;
  *)
    printf 'bv stub: unsupported command %s\n' "${cmd}" >&2
    exit 1
    ;;
esac
