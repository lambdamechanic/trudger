#!/usr/bin/env bash
set -euo pipefail

log_path="${CODEX_MOCK_LOG:-}"
if [[ -n "${log_path}" ]]; then
  printf 'codex %s\n' "$*" >> "${log_path}"
fi

fail_on="${CODEX_MOCK_FAIL_ON:-}"
is_exec=0
is_resume=0
for ((i=1; i<=$#; i++)); do
  arg="${!i}"
  if [[ "$arg" == "exec" ]]; then
    is_exec=1
    next_index=$((i + 1))
    if (( next_index <= $# )); then
      next_arg="${!next_index}"
      if [[ "$next_arg" == "resume" ]]; then
        is_resume=1
      fi
    fi
    break
  fi
done

case "${fail_on}" in
  exec)
    if (( is_exec == 1 )) && (( is_resume == 0 )); then
      exit 1
    fi
    ;;
  resume)
    if (( is_resume == 1 )); then
      exit 1
    fi
    ;;
  *)
    ;;
esac

exit 0
