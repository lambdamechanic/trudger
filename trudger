#!/usr/bin/env bash
set -euo pipefail

# Repo-root shim for Trudger.
# The Rust binary is the canonical implementation.
# The legacy Bash implementation is kept for reference under historical/bash/.

root_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
shim_path="$(cd "$root_dir" && pwd -P)/trudger"

bin="${TRUDGER_RUST_BIN:-}"
if [[ -z "${bin}" ]]; then
  if [[ -x "${root_dir}/target/release/trudger" ]]; then
    bin="${root_dir}/target/release/trudger"
  elif [[ -x "${root_dir}/target/debug/trudger" ]]; then
    bin="${root_dir}/target/debug/trudger"
  fi
fi

if [[ -z "${bin}" ]]; then
  path_bin="$(command -v trudger 2>/dev/null || true)"
  if [[ -n "${path_bin}" && "${path_bin}" == */* && -x "${path_bin}" ]]; then
    resolved="$(cd "$(dirname "${path_bin}")" && pwd -P)/$(basename "${path_bin}")"
    if [[ "${resolved}" != "${shim_path}" ]]; then
      bin="${path_bin}"
    fi
  fi
fi

if [[ -z "${bin}" ]]; then
  cat >&2 <<'EOF'
Rust trudger binary not found.

Build it:
  cargo build --release

Or install it with cargo:
  cargo install --path . --locked

Legacy Bash implementation (deprecated):
  historical/bash/trudger.bash
EOF
  exit 1
fi

exec "${bin}" "$@"
