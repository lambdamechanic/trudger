#!/usr/bin/env bash
set -euo pipefail

# trudger: loop over trudgeable bd tasks and run Codex solve+review prompts.

PROMPT_TRUDGE="${HOME}/.codex/prompts/trudge.md"
PROMPT_REVIEW="${HOME}/.codex/prompts/trudge_review.md"

usage() {
  cat <<'EOF'
Usage: ./trudger

Loop over ready bd tasks labeled trudgeable and run Codex solve+review prompts.
EOF
}

require_prompt() {
  local path="$1"
  if [[ ! -f "$path" ]]; then
    printf 'Missing prompt file: %s\n' "$path" >&2
    exit 1
  fi
}

require_jq() {
  if ! command -v jq >/dev/null 2>&1; then
    printf 'Missing dependency: jq\n' >&2
    exit 1
  fi
}

get_next_task_id() {
  local raw
  raw="$(bd ready --json --label trudgeable --sort priority --limit 1)"
  printf '%s' "$raw" | jq -r 'if type == "array" and length > 0 then .[0].id // "" else "" end' 2>/dev/null || true
}

load_task_state() {
  local task_id="$1"
  local raw
  raw="$(bd show "$task_id" --json)"
  printf '%s' "$raw" | jq -r '
    def item: if type == "array" then .[0] else . end;
    if (type == "array" and length == 0) or type == "null" then
      ["", ""]
    else
      item | [(.status // ""), ((.labels // []) | join(" "))]
    end
    | .[]
  ' 2>/dev/null || true
}

render_prompt() {
  local prompt_path="$1"
  local task_id="$2"
  local content

  content="$(awk '
    NR == 1 && $0 == "---" { in_frontmatter = 1; next }
    in_frontmatter && $0 == "---" { in_frontmatter = 0; next }
    !in_frontmatter { print }
  ' "$prompt_path")"
  printf '%s' "${content//\$ARGUMENTS/$task_id}"
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi

require_jq
require_prompt "$PROMPT_TRUDGE"
require_prompt "$PROMPT_REVIEW"

while true; do
  task_id="$(get_next_task_id)"
  if [[ -z "$task_id" ]]; then
    exit 0
  fi

  bd update "$task_id" --status in_progress
  codex --yolo exec "$(render_prompt "$PROMPT_TRUDGE" "$task_id")"
  codex --yolo exec resume --last "$(render_prompt "$PROMPT_REVIEW" "$task_id")"

  mapfile -t task_state < <(load_task_state "$task_id")
  status="${task_state[0]:-}"
  labels="${task_state[1]:-}"

  if [[ "$status" == "closed" ]]; then
    if printf '%s' "$labels" | grep -q -- 'trudgeable'; then
      bd label remove "$task_id" trudgeable
    fi
    continue
  fi

  if printf '%s' "$labels" | grep -q -- 'requires-human'; then
    if printf '%s' "$labels" | grep -q -- 'trudgeable'; then
      bd label remove "$task_id" trudgeable
    fi
    bd label add "$task_id" requires-human
    continue
  fi

  printf 'Task %s not closed and not requires-human after review.\n' "$task_id" >&2
  exit 1
done
