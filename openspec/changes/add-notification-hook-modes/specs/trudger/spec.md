# trudger Spec Delta

## MODIFIED Requirements

### Requirement: Configuration validation
The system SHALL require `agent_command`, `agent_review_command`, `review_loop_limit`, `commands.task_show`, `commands.task_status`, `commands.task_update_status`, `hooks.on_completed`, and `hooks.on_requires_human` to be present and non-empty.

`commands.next_task` SHALL be required only when no manual task ids are provided.

`log_path` SHALL be optional; when it is missing or empty, logging is disabled.

`hooks.on_notification` SHALL be optional; when present, it MUST be non-empty.

`hooks.on_notification_scope` SHALL be optional; when present, it MUST be one of `all_logs`, `task_boundaries`, or `run_boundaries`. If `hooks.on_notification` is configured and `hooks.on_notification_scope` is omitted, the system SHALL default to `task_boundaries`.

If `hooks.on_notification_scope` is configured while `hooks.on_notification` is not configured, the system SHALL continue startup and SHALL emit a warning that `hooks.on_notification_scope` is ignored.

#### Scenario: Required config value missing
- **WHEN** any required config value is missing or empty
- **THEN** the system exits non-zero with a clear error naming the missing field

#### Scenario: Invalid notification scope errors
- **GIVEN** `hooks.on_notification_scope` is set to an unsupported value
- **WHEN** Trudger validates configuration
- **THEN** it exits non-zero with a clear error naming `hooks.on_notification_scope`

#### Scenario: Notification scope without hook warns and is ignored
- **GIVEN** `hooks.on_notification_scope` is configured
- **AND** `hooks.on_notification` is missing
- **WHEN** Trudger validates configuration
- **THEN** Trudger continues startup
- **AND** it emits a warning that `hooks.on_notification_scope` is ignored

## ADDED Requirements

### Requirement: Optional notification hook dispatch
The system SHALL support an optional notification hook command at `hooks.on_notification`.

When `hooks.on_notification` is not configured, the system SHALL NOT emit notification-hook invocations.

Notification hook dispatch SHALL apply only to task-processing mode (`trudger` default run mode). `trudger wizard` and `trudger doctor` SHALL NOT emit notification-hook invocations.

When `hooks.on_notification` is configured, the system SHALL invoke it according to `hooks.on_notification_scope`:
- `all_logs`: invoke once per transition log message, including when `log_path` is disabled.
- `task_boundaries`: invoke on task start and task end.
- `run_boundaries`: invoke on Trudger run start and run end.

Task-boundary events SHALL be:
- `task_start`: emitted once when a task becomes the current task in the run loop.
- `task_end`: emitted once when that task leaves current-task context due to closure, escalation (`blocked`), interruption, or task-processing error.

Run-boundary events SHALL be:
- `run_start`: emitted once after configuration and prompt validation succeed, before task selection begins.
- `run_end`: emitted once at the absolute end of task-processing teardown (after cleanup/reset/restore steps complete).

The system SHALL make a best-effort attempt to emit `run_end` for every termination path where Trudger can still execute user code (including normal exits, handled interrupts/signals, and error exits). Termination paths that cannot execute user code (for example hard kill) are out of scope.

Notification hook invocations SHALL execute without positional task arguments.

If the notification hook exits non-zero or fails to spawn, the system SHALL continue task processing and SHALL emit a warning/transition describing the notification failure.

When `hooks.on_notification_scope` is `all_logs`, transitions generated by the notification subsystem itself (for example notification failure transitions) SHALL NOT trigger additional notification dispatch.

#### Scenario: Notification hook omitted
- **GIVEN** `hooks.on_notification` is not configured
- **WHEN** Trudger runs
- **THEN** no notification hook command is invoked

#### Scenario: Notification hook is run-mode only
- **GIVEN** `hooks.on_notification` is configured
- **WHEN** a user runs `trudger doctor` or `trudger wizard`
- **THEN** no notification hook command is invoked

#### Scenario: Task boundary notifications
- **GIVEN** `hooks.on_notification` is configured
- **AND** `hooks.on_notification_scope` is `task_boundaries`
- **WHEN** a task starts and later ends
- **THEN** the notification hook is invoked once at start and once at end for that task

#### Scenario: Run boundary notifications
- **GIVEN** `hooks.on_notification` is configured
- **AND** `hooks.on_notification_scope` is `run_boundaries`
- **WHEN** Trudger starts and later exits
- **THEN** the notification hook is invoked once at run start and once at run end

#### Scenario: Run end notification is emitted after teardown
- **GIVEN** `hooks.on_notification` is configured
- **AND** `hooks.on_notification_scope` is `run_boundaries`
- **WHEN** Trudger exits task-processing mode
- **THEN** `run_end` is emitted after cleanup/reset/restore steps complete

#### Scenario: All-log notifications
- **GIVEN** `hooks.on_notification` is configured
- **AND** `hooks.on_notification_scope` is `all_logs`
- **WHEN** Trudger emits transition log messages
- **THEN** the notification hook is invoked once per transition log message

#### Scenario: All-log notifications still run with log file disabled
- **GIVEN** `hooks.on_notification` is configured
- **AND** `hooks.on_notification_scope` is `all_logs`
- **AND** `log_path` is omitted or empty
- **WHEN** Trudger emits transition log messages
- **THEN** the notification hook is invoked once per transition log message

#### Scenario: Notification failures are non-fatal
- **GIVEN** `hooks.on_notification` is configured
- **AND** a notification hook invocation fails
- **WHEN** Trudger is processing a task
- **THEN** task processing continues
- **AND** the failure is surfaced via warning/transition output

#### Scenario: Notification failure does not recurse in all_logs mode
- **GIVEN** `hooks.on_notification_scope` is `all_logs`
- **AND** a notification hook invocation fails
- **WHEN** Trudger records a notification-failure transition
- **THEN** that transition does not trigger another notification-hook invocation

### Requirement: Notification payload contract
For each notification hook invocation, the system SHALL provide `TRUDGER_NOTIFY_*` payload fields via environment variables.

The payload SHALL include:
- `TRUDGER_NOTIFY_EVENT` (one of `run_start`, `run_end`, `task_start`, `task_end`, `log`)
- `TRUDGER_NOTIFY_DURATION_MS` (elapsed duration in milliseconds; see event-specific rules below)
- `TRUDGER_NOTIFY_FOLDER` (absolute invocation working directory)
- `TRUDGER_NOTIFY_EXIT_CODE` (run exit code for `run_end`; unset otherwise)
- `TRUDGER_NOTIFY_TASK_ID` (task id when applicable; empty otherwise)
- `TRUDGER_NOTIFY_TASK_DESCRIPTION` (human-readable task description when available; empty otherwise)

Event-specific duration rules SHALL be:
- `run_start`: `0`
- `run_end`: elapsed milliseconds since `run_start`
- `task_start`: `0`
- `task_end`: elapsed milliseconds since matching `task_start`
- `log`: elapsed milliseconds since `run_start`

Human-readable task description SHALL be derived from the first non-empty trimmed line of the most recent `commands.task_show` output for that task.

When `hooks.on_notification_scope` is `all_logs`, the payload SHALL also include `TRUDGER_NOTIFY_MESSAGE` containing a redacted transition message. Redaction SHALL replace values of `command=` and `args=` segments with `[REDACTED]`. Control characters SHALL be escaped consistently with transition logging.

The exact formatting/parsing details of redacted message output are implementation details and are not a cross-version compatibility contract.

Notification hook invocations SHALL receive existing task/run `TRUDGER_*` context variables in addition to `TRUDGER_NOTIFY_*`.

`TRUDGER_NOTIFY_*` values SHALL be subject to the same environment-size truncation protections as other Trudger-provided environment variables.

#### Scenario: Task notification includes required fields
- **GIVEN** a task notification is emitted
- **WHEN** the notification hook executes
- **THEN** it receives duration, folder, task id, and task description via `TRUDGER_NOTIFY_*` environment variables

#### Scenario: Task description extracted from task_show output
- **GIVEN** `commands.task_show` output includes multiple lines
- **WHEN** Trudger prepares notification payload for that task
- **THEN** `TRUDGER_NOTIFY_TASK_DESCRIPTION` is set to the first non-empty trimmed line

#### Scenario: Run boundary notification has empty task fields
- **GIVEN** a run-boundary notification is emitted outside task context
- **WHEN** the notification hook executes
- **THEN** `TRUDGER_NOTIFY_TASK_ID` and `TRUDGER_NOTIFY_TASK_DESCRIPTION` are empty

#### Scenario: All-log payload includes transition message
- **GIVEN** notification scope is `all_logs`
- **WHEN** a transition log message is emitted
- **THEN** `TRUDGER_NOTIFY_MESSAGE` is set to that transition message for the notification hook invocation

#### Scenario: All-log payload redacts command and args fields
- **GIVEN** notification scope is `all_logs`
- **AND** a transition message includes `command=` and `args=` fields
- **WHEN** Trudger prepares the notification payload
- **THEN** `TRUDGER_NOTIFY_MESSAGE` replaces both field values with `[REDACTED]`

#### Scenario: Run and task start durations are zero
- **GIVEN** a `run_start` or `task_start` notification is emitted
- **WHEN** the notification hook executes
- **THEN** `TRUDGER_NOTIFY_DURATION_MS` is `0`

#### Scenario: Run end payload includes exit code
- **GIVEN** a `run_end` notification is emitted
- **WHEN** the notification hook executes
- **THEN** `TRUDGER_NOTIFY_EXIT_CODE` is set to the run exit code

#### Scenario: Non-run-end payload leaves exit code unset
- **GIVEN** a notification event other than `run_end` is emitted
- **WHEN** the notification hook executes
- **THEN** `TRUDGER_NOTIFY_EXIT_CODE` is unset

#### Scenario: Notification payload values are truncated when oversized
- **GIVEN** a `TRUDGER_NOTIFY_*` payload value exceeds env-size limits
- **WHEN** Trudger executes the notification hook
- **THEN** Trudger truncates the value at a UTF-8 boundary before spawn
- **AND** it emits truncation warnings/transitions consistent with existing env-truncation behavior
